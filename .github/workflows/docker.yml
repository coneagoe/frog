name: Docker Build & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ opened ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Mock environment variables
      run: |
        # Create .env file with mock values for CI/CD
        cat > .env << 'EOF'
        SMTP_HOST=smtp.example.com
        SMTP_PORT=587
        SMTP_MAIL_FROM=test@example.com
        SMTP_USER=testuser
        SMTP_PASSWORD=testpassword
        ALERT_EMAILS=test@example.com
        EOF

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build with Docker Compose
      run: |
        # Build all services defined in docker-compose.yml
        docker compose build
